---
import { getImage } from "astro:assets";
import { getCollection, getEntry, render } from "astro:content";
import readingTime from "reading-time";
import Layout from "../../layouts/Layout.astro";

const { slug } = Astro.params;
const article = await getEntry("blog", slug);
if (!article) {
	throw new Error(`Article not found: ${slug}`);
}

export async function getStaticPaths() {
	const articles = await getCollection("blog");
	return articles.map((entry) => ({ params: { slug: entry.id }, props: { article: entry } }));
}

const { Content } = await render(article);
const minutesRead = Math.max(1, Math.ceil(readingTime(article.body).minutes));

const blogImages = import.meta.glob<Record<string, { default: ImageMetadata }>>(
	"/src/content/blog/**/*.{jpg,png,webp}",
	{ eager: true },
);

const imagePath = article.data.image ? `/src/content/blog/${slug}/${article.data.image}` : undefined;
let img: Awaited<ReturnType<typeof getImage>> | undefined;
if (imagePath) {
	const mod = blogImages[imagePath] as unknown as { default?: ImageMetadata } | undefined;
	if (mod?.default) {
		img = await getImage({
			src: mod.default,
			width: 1200,
			height: 630,
			format: "jpg",
		});
	}
}
---


<Layout 
	title={article.data.title} 
	image={img}
	description={article.data.description} 
	keywords={article.data.keywords}
	noIndex={!article.data.published} 
	canonical={article.data.canonical ?? undefined} 
	noHeader>
  <article>
    {/** Render markdown as HTML using Astro's set:html directive */}
	  <Content />
		<footer>
			<p class="published">
				Published on <time datetime={article.data.date}>{article.data.date.toLocaleDateString()}</time>
				{article.data.canonical && (
					<>
						{' '}via <a href={article.data.canonical} target="_blank" rel="noopener noreferrer">
							{new URL(article.data.canonical).hostname.replace(/^www\./, '').split('.')[0]}
						</a>
					</>
				)} by <a href="/about" class="author">MichaÃ«l Vanderheyden</a>
			</p>
			{article.data.updated && (
				<p class="updated">
					Last updated on <time datetime={article.data.updated}>{article.data.updated.toLocaleDateString()}</time>
				</p>
			)}
		</footer>
  </article>
</Layout>
