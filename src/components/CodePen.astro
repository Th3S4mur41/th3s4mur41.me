---
export interface Props {
	title: string;
	href: string;
	description?: string;
	height?: number;
	defaultTab?: string;
	preview?: boolean;
	user?: string;
	slugHash?: string;
}

const {
	title,
	href,
	description,
	height = 400,
	defaultTab = "result",
	preview = true,
	user: userProp,
	slugHash: slugHashProp,
} = Astro.props;

let user = userProp;
let slugHash = slugHashProp;

try {
	const url = new URL(href);
	const parts = url.pathname.split("/").filter(Boolean);
	if (!user && parts.length > 0) user = parts[0];
	if (!slugHash) {
		const penIndex = parts.indexOf("pen");
		if (penIndex !== -1 && parts[penIndex + 1]) slugHash = parts[penIndex + 1];
	}
} catch (error) {
	console.error("CodePen: failed to parse href for embed", { href, error });
}

if (!user) {
	throw new Error(
		"CodePen: missing user (pass `user` or use a CodePen href like https://codepen.io/<user>/pen/<hash>)",
	);
}

if (!slugHash) {
	throw new Error(
		"CodePen: missing slug hash (pass `slugHash` or use a CodePen href, e.g. https://codepen.io/<user>/pen/<hash>)",
	);
}
---

<figure>
	<p
		class="codepen"
		data-height={height}
		data-default-tab={defaultTab}
		data-slug-hash={slugHash}
		data-pen-title={title}
		data-preview={preview ? 'true' : 'false'}
		data-user={user}
	>
		<span>
			See the Pen <a href={href}>{title}</a> by {user} (<a href={`https://codepen.io/${user}`}>@{user}</a>)
			on <a href="https://codepen.io">CodePen</a>.
		</span>
	</p>

		<figcaption>
			{description} <a href={href}>Open “{title}” on CodePen</a> if the embedded preview is not available.
		</figcaption>
	)
</figure>

<script is:inline>
	(() => {
		const selector = 'script[data-codepen-embed]';

		const ensureScript = () => {
			if (document.querySelector(selector)) return;

			const script = document.createElement('script');
			script.src = 'https://public.codepenassets.com/embed/index.js';
			script.async = true;
			script.setAttribute('data-codepen-embed', 'true');
			document.body.appendChild(script);
		};

		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', ensureScript, { once: true });
		} else {
			ensureScript();
		}
	})();
</script>
