---
import { getImage } from "astro:assets";
import type { ImageMetadata } from "astro";

interface Props {
	src: ImageMetadata;
	alt: string;
	widths?: {
		small?: number;
		medium?: number;
		large?: number;
	};
	sizes?: string;
	loading?: "lazy" | "eager";
	decoding?: "async" | "sync" | "auto";
	class?: string;
	fetchpriority?: "high" | "low" | "auto";
}

const {
	src,
	alt,
	widths = { small: 640, medium: 1024, large: 1920 },
	sizes = "(max-width: 640px) 640px, (max-width: 1024px) 1024px, 1920px",
	loading = "lazy",
	decoding = "async",
	class: className,
	fetchpriority,
} = Astro.props;

// Get original image size
const originalImage = await getImage({ src });
const originalWidth = originalImage.attributes.width;
const originalFormat = src.format || "png";
const isJpeg = originalFormat.toLowerCase() === "jpg" || originalFormat.toLowerCase() === "jpeg";
const fallbackFormat = isJpeg ? "jpg" : "png";

// Generate AVIF images for all sizes based on original size
const avifSmallWidth = Math.min(originalWidth, widths.small);
const avifMediumWidth = Math.min(originalWidth, widths.medium);
const avifLargeWidth = Math.min(originalWidth, widths.large);

const avifSmall = await getImage({ src, width: avifSmallWidth, format: "avif" });
const avifMedium = await getImage({ src, width: avifMediumWidth, format: "avif" });
const avifLarge = await getImage({ src, width: avifLargeWidth, format: "avif" });

// Generate fallback image (use original format for JPEG, PNG otherwise)
const fallbackImage = await getImage({
	src,
	width: originalWidth < widths.medium ? originalWidth : widths.medium,
	format: fallbackFormat,
});

// Create AVIF srcset string based on original size
let avifSrcset = "";
let computedSizes = sizes;

if (originalWidth < widths.small) {
	avifSrcset = `${originalImage.src} ${originalWidth}w`;
	computedSizes = `${originalWidth}px`;
} else if (originalWidth < widths.medium) {
	avifSrcset = `${avifSmall.src} ${widths.small}w, ${originalImage.src} ${originalWidth}w`;
	computedSizes = `(max-width: ${widths.small}px) ${widths.small}px, ${originalWidth}px`;
} else if (originalWidth < widths.large) {
	avifSrcset = `${avifSmall.src} ${widths.small}w, ${avifMedium.src} ${widths.medium}w, ${originalImage.src} ${originalWidth}w`;
	computedSizes = `(max-width: ${widths.small}px) ${widths.small}px, (max-width: ${widths.medium}px) ${widths.medium}px, ${originalWidth}px`;
} else {
	avifSrcset = `${avifSmall.src} ${widths.small}w, ${avifMedium.src} ${widths.medium}w, ${avifLarge.src} ${widths.large}w`;
	computedSizes = sizes;
}
---

<picture>
	<source type="image/avif" srcset={avifSrcset} sizes={computedSizes} />
	<img
		src={fallbackImage.src}
		alt={alt}
		width={fallbackImage.attributes.width}
		height={fallbackImage.attributes.height}
		loading={loading}
		decoding={decoding}
		class={className}
		fetchpriority={fetchpriority}
	/>
</picture>
