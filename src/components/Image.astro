---
import { getImage } from "astro:assets";
import type { ImageMetadata } from "astro";

interface Props {
	src: ImageMetadata;
	alt: string;
	widths?: {
		small?: number;
		medium?: number;
		large?: number;
	};
	sizes?: string;
	loading?: "lazy" | "eager";
	decoding?: "async" | "sync" | "auto";
	class?: string;
	fetchpriority?: "high" | "low" | "auto";
}

const {
	src,
	alt,
	widths = { small: 640, medium: 1024, large: 1920 },
	sizes = "(max-width: 640px) 640px, (max-width: 1024px) 1024px, 1920px",
	loading = "lazy",
	decoding = "async",
	class: className,
	fetchpriority,
} = Astro.props;

// Generate AVIF images for all sizes
const avifSmall = await getImage({
	src,
	width: widths.small,
	format: "avif",
});
const avifMedium = await getImage({
	src,
	width: widths.medium,
	format: "avif",
});
const avifLarge = await getImage({
	src,
	width: widths.large,
	format: "avif",
});

// Generate JPG fallback (medium size)
const jpgFallback = await getImage({
	src,
	width: widths.medium,
	format: "jpg",
});

// Create AVIF srcset string
const avifSrcset = `${avifSmall.src} ${widths.small}w, ${avifMedium.src} ${widths.medium}w, ${avifLarge.src} ${widths.large}w`;
---

<picture>
	<source type="image/avif" srcset={avifSrcset} sizes={sizes} />
	<img
		src={jpgFallback.src}
		alt={alt}
		width={jpgFallback.attributes.width}
		height={jpgFallback.attributes.height}
		loading={loading}
		decoding={decoding}
		class={className}
		fetchpriority={fetchpriority}
	/>
</picture>
